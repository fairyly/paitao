<!DOCTYPE HTML>
<html> 
<head>
<title>留言板</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<link rel="stylesheet" href="css/base_style.css" type="text/css" />
</head>

<body>
<div class="banner">
	<!--这里商品名字不能超过9个字 会爆掉  -->
	<h1 id="_goods_name">商品名称</h1>
		<a class="btnr">
		<div onclick="history.go(-1);" >返回</div></a>
	<a class="btna" href="javascript:location.reload();">
		<div class="refreshbtnbg">刷新</div>
	</a>
</div>
<div class="mess_list" id="mess_list">
	<div id="message_board_div">
	</div>
	<div class="mess_txt" id="target_div">
		<input type="text" name="good_xqfbpltxt" id="good_xqfbpltxt" class="good_xqfbpltxt" placeholder="我来说两句!" onkeydown="return ClearSubmit(event)"/>
		<a class="good_xqfbplbtn good_xqplBtncol" onclick="commit_Message();">发表</a>
	</div>
</div>
<script src="js/jq.js"></script>
<script src="js/jquery.common.js"></script>

<script type="text/javascript">
var _commodityId = $.get_param("commodityId");
var _channelId = $.get_param("channelId");
var _orderId = $.get_param("orderId");

function ClearSubmit(e) {
    if (e.keyCode == 13) {
        return false;
    }
}

function commit_Message(){
	var u_id = window.localStorage.getItem("_user_id");
	if(u_id == null || u_id == undefined || u_id == ''){
		if(window.confirm("请先登录")){
			window.location.href='Login.html';
		}
		return ;
	}
	if(!/\d+/.test(_channelId) || (!/\d+/.test(_orderId) && !/\d+/.test(_commodityId))){
		return ;
	}
	
	var u_name = window.localStorage.getItem('_user_name');
	var u_nick = window.localStorage.getItem('_user_nick');
	var content = $("#good_xqfbpltxt").val();
	var is_exists_nick = true;
	if(content.length < 1){
		alert('留言内容不能为空');
		return ;
	}
	
	if(u_nick == null || u_nick == undefined || u_nick == ''|| u_nick == 'null'){
		if(window.confirm("您还没有设置昵称, 为了您的账户安全, 建议您先设置昵称后再评论")){
			window.location.href='setting_info.html';
			return;
		}else{
			is_exists_nick = false;
		}
	}

	var result="";
  	try{
  		result = window.myAndroidJs.doPostHttpRequest($.get_path("market?type=165&userId="+u_id+"&orderId="+_orderId+"&commodityId="+_commodityId+"&channelId="+_channelId+"&replayContent="+escape(content).replace(/%/g,"%25")+""));
  	}catch (e) {

	}
	if(result!="")
	{
		//result = eval('('+ result +')');
		result = JSON.parse(result);
		if(result.result == 1){
		  if(result.data.result == 'nocomm'){
			  alert("商品不存在或已下架");
			  return ;
		  }else if(result.data.result == 'noorder'){
			  alert('该订单不存在');
			  return ;
		  }else if(result.data.result == 'unde'){
			  var date = new Date();
			  var m = $.num_padding(date.getMonth()+1);
			  var d = $.num_padding(date.getDate());
			  var h = $.num_padding(date.getHours());
			  var mi = $.num_padding(date.getMinutes());
			  var s = $.num_padding(date.getSeconds());
			  var arr = new Array();
			  arr.push("<div class='good_xqpl'>");
			  arr.push("<div class='good_xqplnr'>");
			  arr.push("<div class='mess_per'>系统回复");
			  arr.push("（"+date.getFullYear()+"-"+m+"-"+d+" "+h+":"+mi+":"+s+"）");
			  arr.push("</div>");
			  arr.push("<div class='good_xqpltxt'>非常抱歉, 该商品已下架. 客服功能已关闭");
			  arr.push("</div>");
			  arr.push("</div>");
			  arr.push("</div>");
			  $("#good_xqfbpltxt").val("");
			  $("#message_board_none").remove();
			  $("#message_board_div").append(arr.join(""));
			  return ;
		  }else if(result.data.result == 'noparam'){
			  //alert("参数有误");
			  return ;
		  }else if(result.data.result == 'nospeak'){
			  alert("您已被禁言");
			  return ;
		  }else if(result.data.result == 'nouser'){
			  alert("该用户不存在");
			  return ;
		  }
		  $("#good_xqfbpltxt").val("");
		  var date = new Date();
		  var m = $.num_padding(date.getMonth()+1);
		  var d = $.num_padding(date.getDate());
		  var h = $.num_padding(date.getHours());
		  var mi = $.num_padding(date.getMinutes());
		  var s = $.num_padding(date.getSeconds());
		  
		  var arr = new Array("");
		  arr.push("<div class='good_xqpl'>");
		  arr.push("<div class='good_xqplnr'>");
		  arr.push("<div class='mess_per'>");
		  if(is_exists_nick){
			  arr.push(u_nick);
		  }else{
			  if(u_name.length > 10){
				  arr.push(u_name.substr(0,7)+"****");
			  }else{
				  arr.push(u_name);
			  }
		  }
		  arr.push("（"+date.getFullYear()+"-"+m+"-"+d+" "+h+":"+mi+":"+s+"）");
		  arr.push("</div>");
		  arr.push("<div class='good_xqpltxt'>");
		  arr.push(content);
		  arr.push("</div>");
		  arr.push("</div>");
		  arr.push("</div>");
		  $("#message_board_none").remove();
		  $("#message_board_div").append(arr.join(""));
	  }else{
		  //alert("留言失败");
	  }
	}
}

function get_message_list(callback){
	if(!/\d+/.test(_channelId) || (!/\d+/.test(_orderId) && !/\d+/.test(_commodityId))){
		return ;
	}
	var u_id = window.localStorage.getItem("_user_id");
	if(u_id == null || u_id == undefined || u_id == ''){
		return ;
	}
	var result="";

	if(_orderId == null || _orderId == undefined || _orderId == ''|| _orderId == 'null'){
		try{
  			result = window.myAndroidJs.doPostHttpRequest($.get_path("market?type=180&userId="+u_id+"&channelId="+_channelId+"&commodityId="+_commodityId+""))
	  	}catch (e) {
	  		$.getJSON("http://api.wedanke.com/server/market?jsoncallback=?",{
			   type : 180,
			   userId : u_id,
			   channelId : _channelId,
			   commodityId : _commodityId
			},function(result){
				if(result.result == 1){
					if(result.data.talkName.length > 1){
						$("#_goods_name").html(result.data.talkName.substr(0,8));
					}
					var arr = new Array();
					if(result.data.messageBoardList.length < 1){
						arr.push("<div class='good_xqpl' id='message_board_none'>");
						arr.push("<div class='good_xqplnr'>");
						arr.push("<div class='mess_per'></div>");
						arr.push("<div class='good_xqpltxt'>暂无留言");
						arr.push("</div></div></div>");
					}else{
						for(var i in result.data.messageBoardList){
							var board = result.data.messageBoardList[i];
							arr.push("<div class='good_xqpl'>");
							arr.push("<div class='good_xqplnr'>");
							arr.push("<div class='mess_per'>");
							if(board.msgFrom == 0){
								if(board.userNick != null && board.userNick.length > 0){
									arr.push(board.userNick);
								}else{
									if(board.userName.length == 11){
										arr.push(board.userName.substr(0,8));
										arr.push("****");
									}else{
										arr.push(board.userName);
									}
								}
							}else{
								arr.push(board.channelName);
							}
							arr.push("（");
							arr.push(board.replayTime);
							arr.push("）</div>");
							arr.push("<div class='good_xqpltxt'>");
							arr.push(board.replayContent);
							arr.push("</div></div></div>");
						}
					}
					$("#message_board_div").html(arr.join(""));
				}
			});
		}
	}else{
		try{
  			result = window.myAndroidJs.doPostHttpRequest($.get_path("market?type=180&userId="+u_id+"&channelId="+_channelId+"&orderId="+_orderId+""))
	  	}catch (e) {
	  		$.getJSON("http://api.wedanke.com/server/market?jsoncallback=?",{
			   type : 180,
			   userId : u_id,
			   channelId : _channelId,
			   orderId : _orderId
			},function(result){
				if(result.result == 1){
					if(result.data.talkName.length > 1){
						$("#_goods_name").html(result.data.talkName.substr(0,8));
					}
					var arr = new Array();
					if(result.data.messageBoardList.length < 1){
						arr.push("<div class='good_xqpl' id='message_board_none'>");
						arr.push("<div class='good_xqplnr'>");
						arr.push("<div class='mess_per'></div>");
						arr.push("<div class='good_xqpltxt'>暂无留言");
						arr.push("</div></div></div>");
					}else{
						for(var i in result.data.messageBoardList){
							var board = result.data.messageBoardList[i];
							arr.push("<div class='good_xqpl'>");
							arr.push("<div class='good_xqplnr'>");
							arr.push("<div class='mess_per'>");
							if(board.msgFrom == 0){
								if(board.userNick != null && board.userNick.length > 0){
									arr.push(board.userNick);
								}else{
									if(board.userName.length == 11){
										arr.push(board.userName.substr(0,8));
										arr.push("****");
									}else{
										arr.push(board.userName);
									}
								}
							}else{
								arr.push(board.channelName);
							}
							arr.push("（");
							arr.push(board.replayTime);
							arr.push("）</div>");
							arr.push("<div class='good_xqpltxt'>");
							arr.push(board.replayContent);
							arr.push("</div></div></div>");
						}
					}
					$("#message_board_div").html(arr.join(""));
				}
			});
		}
	}	
	if(result!="")
	{
		//result = eval('('+ result +')');
		result = JSON.parse(result);
	 	if(result.result == 1){
			if(result.data.talkName.length > 1){
				$("#_goods_name").html(result.data.talkName.substr(0,8));
			}
			var arr = new Array();
			if(result.data.messageBoardList.length < 1){
				arr.push("<div class='good_xqpl' id='message_board_none'>");
				arr.push("<div class='good_xqplnr'>");
				arr.push("<div class='mess_per'></div>");
				arr.push("<div class='good_xqpltxt'>暂无留言");
				arr.push("</div></div></div>");
			}else{
				for(var i in result.data.messageBoardList){
					var board = result.data.messageBoardList[i];
					arr.push("<div class='good_xqpl'>");
					arr.push("<div class='good_xqplnr'>");
					arr.push("<div class='mess_per'>");
					if(board.msgFrom == 0){
						if(board.userNick != null && board.userNick.length > 0){
							arr.push(board.userNick);
						}else{
							if(board.userName.length == 11){
								arr.push(board.userName.substr(0,8));
								arr.push("****");
							}else{
								arr.push(board.userName);
							}
						}
					}else{
						arr.push(board.channelName);
					}
					arr.push("（");
					arr.push(board.replayTime);
					arr.push("）</div>");
					arr.push("<div class='good_xqpltxt'>");
					arr.push(board.replayContent);
					arr.push("</div></div></div>");
				}
			}
			$("#message_board_div").html(arr.join(""));
		}
		callback();
	}
	
}

$(function(){
	get_message_list(function(){
		var scrollY = 0 ; 
		scrollY = $('#mess_list').height() - $(window).height()+45;
		$('html,body').animate({scrollTop: scrollY}, 800);
		
	});
}); 
</script>
</body>
</html>